#!/usr/bin/env bash

set -euo pipefail

readonly CREDS_DIR="${HOME}/.docker/credentials-age"
readonly SSH_KEY="${HOME}/.ssh/id_ed25519"
readonly SSH_PUBKEY="${SSH_KEY}.pub"

mkdir -p -m 700 "${CREDS_DIR}"

url_to_filename() {
  echo "${1}" | sed 's|https\?://||; s|/|_|g'
}

cmd_store() {
  local input
  input=$(cat)

  local server_url
  server_url=$(echo "${input}" | jq -r '.ServerURL')

  local filename
  filename=$(url_to_filename "${server_url}")

  echo "${input}" | age -R "${SSH_PUBKEY}" -o "${CREDS_DIR}/${filename}.age"
}

cmd_get() {
  local server_url
  server_url=$(cat)

  local filename
  filename=$(url_to_filename "${server_url}")

  local cred_file="${CREDS_DIR}/${filename}.age"

  if [[ ! -f "${cred_file}" ]]; then
    echo "{}"
    return
  fi

  age -d -i "${SSH_KEY}" "${cred_file}" | jq -c '{Username: .Username, Secret: .Secret}'
}

cmd_erase() {
  local server_url
  server_url=$(cat)

  local filename
  filename=$(url_to_filename "${server_url}")

  rm -f "${CREDS_DIR}/${filename}.age"
}

cmd_list() {
  local result="{}"

  for cred_file in "${CREDS_DIR}"/*.age; do
    [[ -f "${cred_file}" ]] || continue

    local data
    data=$(age -d -i "${SSH_KEY}" "${cred_file}" 2>/dev/null) || continue

    local server_url username
    server_url=$(echo "${data}" | jq -r '.ServerURL')
    username=$(echo "${data}" | jq -r '.Username')

    result=$(echo "${result}" | jq --arg url "${server_url}" --arg user "${username}" '. + {($url): $user}')
  done

  echo "${result}"
}

case "${1:-}" in
  store) cmd_store ;;
  get) cmd_get ;;
  erase) cmd_erase ;;
  list) cmd_list ;;
  *) echo "Usage: ${0} {store|get|erase|list}" >&2; exit 1 ;;
esac
