#!/usr/bin/env bash

set -euo pipefail

current_sink=$(audio-sink current)
new_sink=$(audio-sink alsa)

# Toggle to Bluetooth if currently on ALSA.
if [[ "$current_sink" != bluez_output* ]]; then
  bluetooth_sink=$(audio-sink bluetooth)

  if [[ -z "$bluetooth_sink" ]]; then
    bluetooth-reconnect || true
    bluetooth_sink=$(audio-sink bluetooth)
  fi

  if [[ -n "$bluetooth_sink" ]]; then
    new_sink="$bluetooth_sink"
  fi
fi

# Switch to the new sink and move all active audio streams.
pactl set-default-sink "$new_sink"
pactl list short sink-inputs | awk '{print $1}' | while read -r stream_id; do
  pactl move-sink-input "$stream_id" "$new_sink" 2>/dev/null || true
done

# Alert on which sink is now active.
if [[ "$new_sink" == bluez_output* ]]; then
  icon="audio-headphones-symbolic"
else
  icon="audio-speakers-symbolic"
fi

swayosd-client --custom-icon "$icon" \
  --custom-message "$(audio-sink description "$new_sink")"
