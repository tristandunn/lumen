#!/usr/bin/env bash

set -euo pipefail

# Exclude PCI controllers and sinks with all ports unavailable.
available_sinks=$(
  pactl -f json list sinks | jq -r '
    [.[] | select(.name | test("^alsa_output\\.pci") | not)
          | select(.ports == [] or (.ports | any(.availability != "not available")))]
    | .[].name
  '
)

if [[ -z "$available_sinks" ]]; then
  echo "No available sinks found." >&2
  exit 1
fi

# Find the current default sink and cycle to the next available.
current_sink=$(pactl get-default-sink)
new_sink=$(
  echo "$available_sinks" | awk -v current="$current_sink" '
    NR == 1 { first = $0 }
    prev { print; done = 1; exit }
    $0 == current { prev = 1 }
    END { if (!done) print first }
  '
)

# Switch to the sink and move all active streams.
pactl set-default-sink "$new_sink"
pactl list short sink-inputs | awk '{print $1}' | while read -r stream_id; do
  pactl move-sink-input "$stream_id" "$new_sink" 2>/dev/null || true
done

# Display headphones symbol for Bluetooth.
if [[ "$new_sink" == bluez_output* ]]; then
  icon="audio-headphones-symbolic"
else
  icon="audio-speakers-symbolic"
fi

# Alert on which sink is now active.
swayosd-client --custom-icon "$icon" \
  --custom-message "$(lumen-audio-sink description "$new_sink")"
